---
title: "Automatically generated report of the consensus residue contact network"
author: "Raphael Peer"
date: "29/09/2015"
output: html_document
toc: yes
---

---

# About this report

This preliminary report about the consensus residue contact network is automatically generated by the script 'analysis.Rmd'. The script can be easily modified (most conveniently in RStudio) to use different parameters for the plots below or to exapand the analysis.

# The data

The analysis at hand reads in the the following files:


* consensus_network.csv (directory 'results'): This file is the main result of this software and lists all contacts. The residue numbers are provided as positions in the reference alignment (and PDB-positions of a given reference structure). The column 'conservation' specifies the fraction of all structures in the dataset which have a contact between the two residues. For instance, a value of 1 means that all structures in the dataset have a contact between the two residues.
* reference alignment (directory 'data'): The reference alignment is provided by the user (in fasta format). The software uses it to identify structurally equivalent resiudes. This way, residue contacts can be compared across structures even though the residues may be named differently in different structures.

```{r, message=F, echo=F}
nw <- read.csv('../results/consensus_network.csv', stringsAsFactors=F)

require(Biostrings)
alignment <- readAAStringSet('../data/ras_reference_alignment.fa', 'fasta')
```


# Contact matrix of consensus contacts

The plot below shows a matrix of residue contacts. The x- and y-axis are the positions of the reference alignment. A dot indicates that contact between two given residues is present in at least 90% of all structures.

## Possible modifications in the script

All easy to make changes are highlighted with comments in capital letters in the script 'analysis.Rmd'.


* In order to change the cutoff to a different value (e.g. to show only contacts present in ALL structures), change the varialbe 'contact_conservation_cutoff' in the script 'analysis.Rmd'
* To use the PDB-numbers of the reference structure rather than alignment positions as x- and y-axis, uncomment the line calling the function 'plot_contact_matrix_ref_pdb()'

```{r, message=F, echo=F}
require(ggplot2)
plot_contact_matrix <- function(netw, title) {
  seq_length = width(alignment[1])  # length of the alignment
  g <- ggplot(netw) +
    geom_point( aes(x=alignment_pos_A, y=alignment_pos_B), color='grey10', size=0.6) +
    #geom_point( aes(x=ref_pdb_A, y=ref_pdb_B), color='grey10', size=0.6) +
    scale_x_continuous(limits=c(0, seq_length), breaks=(1:(seq_length/50))*50) +
    scale_y_continuous(limits=c(0, seq_length), breaks=(1:(seq_length/50))*50) +
    # axes have to have the same limits in all plots for comparability
    xlab('residue A (alignment position)') +
    ylab('residue B (alignment position)') +
    ggtitle(sprintf('Consensus network:\n%s', title)) +
    theme(plot.title = element_text(size=14, face='bold'))
  g
}

# same function as above only using differen residue numbers:
# PDB-numbers of the reference structure instead of alignment positions
plot_contact_matrix_ref_pdb <- function(netw, title) {
  seq_length = width(alignment[1])  # length of the alignment
  g <- ggplot(netw) +
    geom_point( aes(x=ref_pdb_A, y=ref_pdb_B), color='grey10', size=0.6) +
    xlab('residue A (reference structure PDB-number)') +
    ylab('residue B (reference structure PDB-number)') +
    ggtitle(sprintf('Consensus network:\n%s', title)) +
    theme(plot.title = element_text(size=14, face='bold'))
  g
}

contact_conservation_cutoff = 0.9  # SET VALUE TO WHATEVER SUITS YOUR PROJECT
subset1 <- subset(nw, conservation >= contact_conservation_cutoff)
title1 <- paste0('contacts present in at least ', contact_conservation_cutoff*100, '% of all structures')
plot_contact_matrix(subset1, title1)

# THE SAME PLOT AS ABOVE - ONLY WITH THE PDB-NUMBERS OF THE REFERENCE STRUCTURE AS RESIDUE NUMBERS
# (INSTEAD OF ALIGNMENT POSITION):
# plot_contact_matrix_ref_pdb(subset1, title1)  # uncomment line to show the plot
```


# Distribution of sequence separation of contacting residues

In any given given structure, short range contacts outnumber long range contacts. Therefore, it is not surprising that the same is true for consensus contacts (residue contacts present in all or most structures of a given protein family). The plot below shows the number of consensus residue contacts at a given sequence separation. It shows that the vast majority of consensus contacts is short range.

```{r, message=F, echo=F}
nw$seq_separation <- nw$alignment_pos_B - nw$alignment_pos_A

g <- ggplot(data=subset(nw, conservation >= contact_conservation_cutoff)) +
  geom_histogram( aes(x=seq_separation), fill='grey80', color='grey10', binwidth=1) +
  scale_x_continuous(expand = c(0, 0)) +  # place x-axis at origin
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab('sequence separation') +
  ylab('number of contacts') +
  ggtitle('Distribution of sequence separation of contacting residues') +
  theme(plot.title = element_text(size=15, face='bold'))
g
```


# Contact matrix of consensus contacts excluding short range contacts

Depending on the project at hand short range contacts may not be of interest. Therefore, the plot below shows the contact matrix without short range contacts. In this example, only contacts between residues which are more than 4 residues apart in the sequence are shown. Among the excluded contacts are the hydrogen bonds of the alpha helix (as in the alpha helix, residue i contacts residue i+4).

In order to change the cutoff to a different value (e.g. to show only contacts between residues which are at least 10 residues apart in the sequence), change the varialbe 'sequence_separation_cutoff' in the script 'analysis.Rmd' (highlighted by comment in capital letters).

```{r, message=F, echo=F}
sequence_separation_cutoff = 4  # SET VALUE TO WHATEVER SUITS YOUR PROJECT
nw$short_range <- nw$seq_separation <= sequence_separation_cutoff

subset2 <- subset(nw, conservation >= contact_conservation_cutoff & short_range == FALSE)
title2 <- paste0('short range contacts (more than ', sequence_separation_cutoff, ' residues apart in sequence)\npresent in at least ', contact_conservation_cutoff*100, '% of all structures')
plot_contact_matrix(subset2, title2)

# THE SAME PLOT AS ABOVE - ONLY WITH THE PDB-NUMBERS OF THE REFERENCE STRUCTURE AS RESIDUE NUMBERS
# (INSTEAD OF ALIGNMENT POSITION):
# plot_contact_matrix_ref_pdb(subset2, title2)  # uncomment line to show the plot
```


# Fraction of consensus contacts as function of contact-conservation cutoff

The plot below shows the number contacts shared between a given fraction of all structures.

```{r, message=F, echo=F}
cutoffs <- (0:10)/10
number_of_common_contacts <- sapply(cutoffs, function(x) nrow(subset(nw, conservation >= x)))

df <- data.frame(cutoffs, number_of_common_contacts)

g <- ggplot(data=df) +
  geom_point( aes(x=cutoffs, y=number_of_common_contacts), size=2 ) +
  theme_bw() +
  scale_x_continuous(breaks =seq(min(cutoffs), max(cutoffs), by = 0.2)) +
  ylab('number of contacts') +
  xlab('contact-conservation cutoff') +
  ggtitle('Common contacts as function of contact-conservation cutoff') +
  theme(plot.title = element_text(size=14, face='bold'))
g
```

